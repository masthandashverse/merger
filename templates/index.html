<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üé¨ Video & Subtitle Merger</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:'Segoe UI',sans-serif;
  background:linear-gradient(135deg,#0f0c29,#302b63,#24243e);
  min-height:100vh;color:#fff;padding:24px 16px;
}
.wrap{max-width:860px;margin:0 auto}

.hdr{text-align:center;padding:28px 24px 20px;
  background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);
  border-radius:20px;margin-bottom:20px}
.hdr .ico{font-size:46px;display:block;margin-bottom:8px}
.hdr h1{font-size:26px;font-weight:800;margin-bottom:4px}
.hdr p{color:rgba(255,255,255,.5);font-size:13px}

.card{
  background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);
  border-radius:16px;padding:22px;margin-bottom:16px;
}
.card-title{font-size:14px;font-weight:700;margin-bottom:14px;
  display:flex;align-items:center;gap:8px;color:rgba(255,255,255,.85)}

.mode-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.mode-card{
  border:2px solid rgba(255,255,255,.1);border-radius:12px;
  padding:16px;cursor:pointer;transition:.25s;position:relative;
  background:rgba(255,255,255,.04)
}
.mode-card:hover{border-color:rgba(99,102,241,.35)}
.mode-card.sel{border-color:#6366f1;background:rgba(99,102,241,.1)}
.mode-card input[type=radio]{display:none}
.mode-card .mico{font-size:22px;display:block;margin-bottom:6px}
.mode-card h4{font-size:13px;font-weight:700;margin-bottom:3px}
.mode-card p{color:rgba(255,255,255,.38);font-size:11px;line-height:1.4}
.mode-badge{
  position:absolute;top:9px;right:9px;
  background:rgba(99,102,241,.2);color:#a5b4fc;
  font-size:10px;padding:2px 8px;border-radius:20px;font-weight:700
}

.ep-toolbar{display:flex;justify-content:space-between;align-items:center;
  margin-bottom:14px;flex-wrap:wrap;gap:8px}
.ep-toolbar .card-title{margin-bottom:0}
.ep-cnt{background:rgba(99,102,241,.2);color:#a5b4fc;font-size:11px;
  padding:2px 10px;border-radius:20px;font-weight:700}
.add-ep-btn{
  background:rgba(16,185,129,.15);border:1px solid rgba(16,185,129,.3);
  color:#6ee7b7;padding:8px 16px;border-radius:8px;cursor:pointer;
  font-size:13px;font-weight:700;transition:.2s
}
.add-ep-btn:hover{background:rgba(16,185,129,.28)}

.ep-card{
  background:rgba(255,255,255,.03);border:1.5px solid rgba(255,255,255,.08);
  border-radius:14px;padding:18px;margin-bottom:12px;
  transition:border-color .3s,background .3s;
}
.ep-card.processing{border-color:rgba(99,102,241,.5);background:rgba(99,102,241,.06)}
.ep-card.completed {border-color:rgba(16,185,129,.5);background:rgba(16,185,129,.06)}
.ep-card.error     {border-color:rgba(255,59,48,.5); background:rgba(255,59,48,.06)}

.ep-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.ep-label{display:flex;align-items:center;gap:8px;font-size:13px;font-weight:700;color:#a5b4fc}
.ep-num{
  background:rgba(99,102,241,.2);width:28px;height:28px;border-radius:8px;
  display:flex;align-items:center;justify-content:center;font-size:12px
}
.del-btn{
  background:rgba(255,59,48,.15);border:1px solid rgba(255,59,48,.2);
  color:#ff6b6b;width:28px;height:28px;border-radius:8px;
  cursor:pointer;font-size:14px;display:flex;align-items:center;
  justify-content:center;transition:.2s
}
.del-btn:hover{background:rgba(255,59,48,.32)}

.ep-fields{display:flex;flex-direction:column;gap:10px}
.ep-row{display:grid;grid-template-columns:80px 1fr;gap:8px;align-items:center}
.ep-row label{font-size:11px;color:rgba(255,255,255,.4);font-weight:700;
  text-transform:uppercase;letter-spacing:.5px}
.ep-row .inp-wrap{display:flex;gap:6px;align-items:center}

.upload-zone{
  flex:1;border:1.5px dashed rgba(255,255,255,.15);border-radius:9px;
  padding:10px 14px;display:flex;align-items:center;gap:10px;
  cursor:pointer;transition:.2s;position:relative;overflow:hidden;
  background:rgba(255,255,255,.03);min-height:44px;
}
.upload-zone:hover{border-color:rgba(99,102,241,.45);background:rgba(99,102,241,.05)}
.upload-zone.has-file{border-color:rgba(16,185,129,.5);background:rgba(16,185,129,.07)}
.upload-zone.drag-over{border-color:#6366f1;background:rgba(99,102,241,.12)}
.upload-zone input[type=file]{
  position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;
}
.zone-ico{font-size:18px;flex-shrink:0}
.zone-body{flex:1;overflow:hidden}
.zone-title{font-size:12px;color:rgba(255,255,255,.5);font-weight:600}
.zone-file{font-size:12px;color:#6ee7b7;font-weight:600;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.zone-size{font-size:11px;color:rgba(255,255,255,.3);margin-top:1px}
.zone-clear{
  background:rgba(255,59,48,.2);border:none;color:#ff6b6b;
  width:22px;height:22px;border-radius:50%;cursor:pointer;
  font-size:12px;flex-shrink:0;display:none;
  align-items:center;justify-content:center;z-index:10;
}
.upload-zone.has-file .zone-clear{display:flex}

.name-input{
  flex:1;background:rgba(255,255,255,.06);
  border:1.5px solid rgba(255,255,255,.1);border-radius:9px;
  padding:10px 13px;color:#fff;font-size:13px;outline:none;
}
.name-input:focus{border-color:#6366f1}
.name-input::placeholder{color:rgba(255,255,255,.2)}

.ep-prog{margin-top:12px}
.prog-bar-bg{
  background:rgba(255,255,255,.08);border-radius:10px;height:6px;overflow:hidden
}
.prog-bar-fill{
  height:100%;border-radius:10px;
  background:linear-gradient(90deg,#6366f1,#8b5cf6,#6366f1);
  background-size:200%;
  transition:width .4s ease;
  animation:shimmer 2s linear infinite;
}
@keyframes shimmer{0%{background-position:200%}100%{background-position:-200%}}
.prog-info{display:flex;justify-content:space-between;margin-top:5px}
.prog-msg{font-size:11px;color:rgba(255,255,255,.45)}
.prog-pct{font-size:11px;color:rgba(255,255,255,.45);font-weight:700}

.ep-status{
  display:none;margin-top:10px;padding:8px 12px;border-radius:8px;
  font-size:12px;align-items:center;gap:8px
}
.ep-status.show{display:flex}
.ep-status.queued     {background:rgba(255,255,255,.05);color:rgba(255,255,255,.45)}
.ep-status.processing {background:rgba(99,102,241,.1);  color:#a5b4fc}
.ep-status.completed  {background:rgba(16,185,129,.1);  color:#6ee7b7}
.ep-status.error      {background:rgba(255,59,48,.1);   color:#ff6b6b}

.spin{
  width:13px;height:13px;border:2px solid rgba(255,255,255,.2);
  border-top-color:currentColor;border-radius:50%;
  animation:spin 1s linear infinite;flex-shrink:0
}
@keyframes spin{to{transform:rotate(360deg)}}

/* ‚îÄ‚îÄ download button per episode ‚îÄ‚îÄ */
.ep-dl-btn{
  display:none;margin-top:10px;padding:9px 18px;border-radius:8px;
  background:linear-gradient(135deg,#10b981,#059669);
  border:none;color:#fff;font-size:13px;font-weight:700;
  cursor:pointer;transition:.2s;align-items:center;gap:8px;
  box-shadow:0 4px 15px rgba(16,185,129,.3);
}
.ep-dl-btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(16,185,129,.4)}
.ep-dl-btn.show{display:inline-flex}

.merge-btn{
  width:100%;padding:15px;
  background:linear-gradient(135deg,#6366f1,#8b5cf6);
  color:#fff;border:none;border-radius:12px;
  font-size:15px;font-weight:800;cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:10px;
  text-transform:uppercase;letter-spacing:1px;transition:.3s
}
.merge-btn:hover:not(:disabled){
  transform:translateY(-2px);box-shadow:0 10px 30px rgba(99,102,241,.4)}
.merge-btn:disabled{opacity:.45;cursor:not-allowed}
.spin-lg{
  width:20px;height:20px;border:3px solid rgba(255,255,255,.3);
  border-top-color:#fff;border-radius:50%;
  animation:spin 1s linear infinite;display:none
}
.merge-btn.loading .spin-lg{display:block}
.merge-btn.loading .btn-txt{display:none}
.merge-btn.loading .loading-txt{display:inline}
.loading-txt{display:none}

.batch-msg{
  display:none;margin-top:14px;padding:13px 16px;border-radius:10px;
  font-size:13px;line-height:1.6
}
.batch-msg.show{display:block}
.batch-msg.info   {background:rgba(99,102,241,.15);border:1px solid rgba(99,102,241,.3);color:#a5b4fc}
.batch-msg.success{background:rgba(16,185,129,.15);border:1px solid rgba(16,185,129,.3);color:#6ee7b7}
.batch-msg.error  {background:rgba(255,59,48,.15); border:1px solid rgba(255,59,48,.3); color:#ff6b6b}

.summary{display:none}
.summary.show{display:block}
.sum-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px}
.sum-stat{text-align:center;padding:14px;background:rgba(255,255,255,.05);border-radius:10px}
.sum-stat .n{font-size:26px;font-weight:800;display:block}
.sum-stat .l{font-size:10px;color:rgba(255,255,255,.35);text-transform:uppercase}
.sum-stat.ok .n{color:#6ee7b7}
.sum-stat.fail .n{color:#ff6b6b}
.sum-stat.tot .n{color:#a5b4fc}

.empty{text-align:center;padding:30px;color:rgba(255,255,255,.25);font-size:13px}
.warn{
  background:rgba(255,59,48,.1);border:1px solid rgba(255,59,48,.3);
  border-radius:10px;padding:12px 16px;margin-bottom:16px;
  color:#ff6b6b;font-size:12px;line-height:1.6
}

@media(max-width:600px){
  .mode-row{grid-template-columns:1fr}
  .ep-row{grid-template-columns:1fr;gap:4px}
  .ep-row label{margin-bottom:-2px}
}
</style>
</head>
<body>
<div class="wrap">

  <div class="hdr">
    <span class="ico">üé¨</span>
    <h1>Video &amp; Subtitle Merger</h1>
    <p>Upload MP4 + SRT ‚Äî merge and download instantly</p>
  </div>

  {% if not ffmpeg_ok %}
  <div class="warn">
    <strong>‚ö†Ô∏è FFmpeg not found!</strong><br>
    Mac: <code>brew install ffmpeg</code> &nbsp;|&nbsp;
    Linux: <code>sudo apt install ffmpeg</code> &nbsp;|&nbsp;
    Windows: <a href="https://www.gyan.dev/ffmpeg/builds/" target="_blank"
                style="color:#ff9999">gyan.dev</a>
  </div>
  {% endif %}

  <!-- merge mode -->
  <div class="card">
    <div class="card-title">‚öôÔ∏è Subtitle Mode</div>
    <div class="mode-row">
      <label class="mode-card sel" id="hardCard" onclick="selMode('hard')">
        <input type="radio" name="mode" value="hard" checked>
        <span class="mode-badge">RECOMMENDED</span>
        <span class="mico">üî•</span>
        <h4>Hard Subtitles</h4>
        <p>Burned in. Always visible. Works on any device/player.</p>
      </label>
      <label class="mode-card" id="softCard" onclick="selMode('soft')">
        <input type="radio" name="mode" value="soft">
        <span class="mode-badge">FAST</span>
        <span class="mico">üìé</span>
        <h4>Soft Subtitles</h4>
        <p>Separate track. Toggle in player (VLC ‚Üí V). Output: MKV</p>
      </label>
    </div>
  </div>

  <!-- episodes -->
  <div class="card">
    <div class="ep-toolbar">
      <div class="card-title">
        üéûÔ∏è Episodes
        <span class="ep-cnt" id="epCnt">0</span>
      </div>
      <button class="add-ep-btn" onclick="addEp()">Ôºã Add Episode</button>
    </div>
    <div id="epList"></div>
    <div class="empty" id="emptyMsg">
      Click <strong>Ôºã Add Episode</strong> to get started
    </div>
  </div>

  <!-- merge button -->
  <div class="card">
    <button class="merge-btn" id="mergeBtn" onclick="startMerge()" disabled>
      <div class="spin-lg"></div>
      <span class="btn-txt">üöÄ Merge All Episodes</span>
      <span class="loading-txt">Processing‚Ä¶</span>
    </button>
    <div class="batch-msg" id="batchMsg"></div>
  </div>

  <!-- summary -->
  <div class="card summary" id="summaryCard">
    <div class="card-title">üìä Batch Summary</div>
    <div class="sum-stats">
      <div class="sum-stat ok">
        <span class="n" id="sOk">0</span>
        <span class="l">Completed</span>
      </div>
      <div class="sum-stat fail">
        <span class="n" id="sFail">0</span>
        <span class="l">Failed</span>
      </div>
      <div class="sum-stat tot">
        <span class="n" id="sTot">0</span>
        <span class="l">Total</span>
      </div>
    </div>
  </div>

</div>

<script>
let eps     = [];
let batchId = null;
let evtSrc  = null;

// ‚îÄ‚îÄ episodes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addEp() {
  eps.push({ name: '', videoFile: null, srtFile: null });
  renderEps();
  updateBtn();
  const last = document.querySelector(`#ep-name-${eps.length - 1}`);
  if (last) setTimeout(() => last.focus(), 60);
}

function removeEp(i) {
  eps.splice(i, 1);
  renderEps();
  updateBtn();
}

function renderEps() {
  const list  = document.getElementById('epList');
  const empty = document.getElementById('emptyMsg');
  document.getElementById('epCnt').textContent = eps.length;

  if (!eps.length) {
    list.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  list.innerHTML = eps.map((ep, i) => `
  <div class="ep-card" id="ep-card-${i}">
    <div class="ep-head">
      <div class="ep-label">
        <span class="ep-num">${i + 1}</span>
        Episode ${i + 1}
      </div>
      <button class="del-btn" onclick="removeEp(${i})">‚úï</button>
    </div>
    <div class="ep-fields">

      <div class="ep-row">
        <label>üìõ Name</label>
        <input class="name-input" id="ep-name-${i}"
               placeholder="Episode ${i + 1}"
               value="${esc(ep.name)}"
               oninput="eps[${i}].name=this.value;updateBtn()">
      </div>

      <div class="ep-row">
        <label>üé• MP4</label>
        <div class="inp-wrap">
          <div class="upload-zone ${ep.videoFile?'has-file':''}" id="vzone-${i}"
               ondragover="onDrag(event,${i},'video')"
               ondragleave="offDrag(event,${i},'video')"
               ondrop="onDrop(event,${i},'video')">
            <input type="file" accept=".mp4,.mkv,.avi,.mov,.wmv,.flv,.webm,.m4v"
                   onchange="handleFile(${i},'video',this)">
            <span class="zone-ico">${ep.videoFile?'‚úÖ':'üé¨'}</span>
            <div class="zone-body">
              <div class="zone-title">${ep.videoFile?'':'Click or drag video here'}</div>
              <div class="zone-file">${ep.videoFile?ep.videoFile.name:''}</div>
              <div class="zone-size">${ep.videoFile?fmtSize(ep.videoFile.size):''}</div>
            </div>
            <button class="zone-clear" onclick="clearFile(event,${i},'video')">‚úï</button>
          </div>
        </div>
      </div>

      <div class="ep-row">
        <label>üìù SRT</label>
        <div class="inp-wrap">
          <div class="upload-zone ${ep.srtFile?'has-file':''}" id="szone-${i}"
               ondragover="onDrag(event,${i},'srt')"
               ondragleave="offDrag(event,${i},'srt')"
               ondrop="onDrop(event,${i},'srt')">
            <input type="file" accept=".srt,.ass,.ssa,.vtt,.sub"
                   onchange="handleFile(${i},'srt',this)">
            <span class="zone-ico">${ep.srtFile?'‚úÖ':'üìù'}</span>
            <div class="zone-body">
              <div class="zone-title">${ep.srtFile?'':'Click or drag SRT here'}</div>
              <div class="zone-file">${ep.srtFile?ep.srtFile.name:''}</div>
              <div class="zone-size">${ep.srtFile?fmtSize(ep.srtFile.size):''}</div>
            </div>
            <button class="zone-clear" onclick="clearFile(event,${i},'srt')">‚úï</button>
          </div>
        </div>
      </div>

    </div>

    <div class="ep-prog" id="ep-prog-${i}" style="display:none">
      <div class="prog-bar-bg">
        <div class="prog-bar-fill" id="ep-fill-${i}" style="width:0%"></div>
      </div>
      <div class="prog-info">
        <span class="prog-msg" id="ep-msg-${i}">Waiting‚Ä¶</span>
        <span class="prog-pct" id="ep-pct-${i}">0%</span>
      </div>
    </div>

    <div class="ep-status" id="ep-st-${i}">
      <div class="spin"></div>
      <span id="ep-st-txt-${i}"></span>
    </div>

    <button class="ep-dl-btn" id="ep-dl-${i}" onclick="dlEp(${i})">
      ‚¨áÔ∏è Download Merged Video
    </button>
  </div>
  `).join('');
}

function handleFile(i, type, input) {
  const file = input.files[0];
  if (!file) return;
  if (type==='video') eps[i].videoFile = file;
  else                eps[i].srtFile   = file;
  if (type==='video' && !eps[i].name)
    eps[i].name = file.name.replace(/\.[^/.]+$/,'');
  renderEps(); updateBtn();
}

function clearFile(e, i, type) {
  e.preventDefault(); e.stopPropagation();
  if (type==='video') eps[i].videoFile = null;
  else                eps[i].srtFile   = null;
  renderEps(); updateBtn();
}

function onDrag(e, i, type) {
  e.preventDefault();
  const z = document.getElementById(type==='video'?`vzone-${i}`:`szone-${i}`);
  if (z) z.classList.add('drag-over');
}
function offDrag(e, i, type) {
  e.preventDefault();
  const z = document.getElementById(type==='video'?`vzone-${i}`:`szone-${i}`);
  if (z) z.classList.remove('drag-over');
}
function onDrop(e, i, type) {
  e.preventDefault(); offDrag(e, i, type);
  const file = e.dataTransfer.files[0];
  if (!file) return;
  if (type==='video') eps[i].videoFile = file;
  else                eps[i].srtFile   = file;
  if (type==='video' && !eps[i].name)
    eps[i].name = file.name.replace(/\.[^/.]+$/,'');
  renderEps(); updateBtn();
}

function selMode(m) {
  document.getElementById('hardCard').classList.toggle('sel', m==='hard');
  document.getElementById('softCard').classList.toggle('sel', m==='soft');
  document.querySelector(`input[value="${m}"]`).checked = true;
}

function updateBtn() {
  const valid = eps.filter(e => e.videoFile && e.srtFile).length;
  const btn   = document.getElementById('mergeBtn');
  btn.disabled = valid === 0;
  btn.querySelector('.btn-txt').textContent =
    valid > 0
      ? `üöÄ Merge ${valid} Episode${valid>1?'s':''}`
      : 'üöÄ Merge All Episodes';
}

// ‚îÄ‚îÄ merge ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function startMerge() {
  const valid = eps.filter(e => e.videoFile && e.srtFile);
  if (!valid.length) return;

  const mode = document.querySelector('input[name="mode"]:checked').value;

  document.getElementById('summaryCard').classList.remove('show');
  document.getElementById('mergeBtn').classList.add('loading');
  document.getElementById('mergeBtn').disabled = true;
  showMsg('‚è≥ Uploading files‚Ä¶', 'info');

  valid.forEach((_, vi) => {
    const gi = eps.indexOf(valid[vi]);
    showProg(gi, true);
    setEpStatus(gi, 'Uploading‚Ä¶', 'processing');
    // hide old download buttons
    const dl = document.getElementById(`ep-dl-${gi}`);
    if (dl) dl.classList.remove('show');
  });

  const fd = new FormData();
  fd.append('merge_type',    mode);
  fd.append('episode_count', valid.length);

  valid.forEach((ep, vi) => {
    fd.append(`ep_name_${vi}`, ep.name.trim() || `Episode_${vi+1}`);
    fd.append(`video_${vi}`,   ep.videoFile, ep.videoFile.name);
    fd.append(`srt_${vi}`,     ep.srtFile,   ep.srtFile.name);
  });

  try {
    const resp = await fetch('/merge', { method:'POST', body:fd });
    const data = await resp.json();
    if (!resp.ok) throw new Error(data.error || 'Server error');

    batchId = data.batch_id;
    showMsg(`‚è≥ Merging ${data.ep_count} episode${data.ep_count>1?'s':''}‚Ä¶`, 'info');
    listenProgress(batchId, valid);

  } catch (err) {
    showMsg(`‚ùå ${err.message}`, 'error');
    resetBtn();
  }
}

// ‚îÄ‚îÄ progress ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function listenProgress(id, validEps) {
  if (evtSrc) evtSrc.close();
  evtSrc = new EventSource(`/progress_stream/${id}`);
  evtSrc.onmessage = ev => {
    const data = JSON.parse(ev.data);
    if (data._done) { evtSrc.close(); return; }
    applyProgress(data, validEps);
    if (data._final) { evtSrc.close(); handleComplete(data._final); }
  };
  evtSrc.onerror = () => { evtSrc.close(); pollProgress(id, validEps); };
}

function pollProgress(id, validEps) {
  const iv = setInterval(async () => {
    try {
      const r    = await fetch(`/progress/${id}`);
      const data = await r.json();
      applyProgress(data, validEps);
      if (data._final) { clearInterval(iv); handleComplete(data._final); }
    } catch(e) {}
  }, 1500);
}

function applyProgress(data, validEps) {
  validEps.forEach((ep, vi) => {
    const info = data[`ep_${vi}`];
    if (!info) return;
    const gi = eps.indexOf(ep);
    updateProgBar(gi, info.pct||0, info.msg||'');
    setEpStatus(gi, info.msg||'', info.status||'processing');
    setCardClass(gi, info.status);
  });
}

function handleComplete(fin) {
  const results = fin?.results || [];
  let ok = 0, fail = 0;

  results.forEach((r, vi) => {
    const ep   = eps.filter(e => e.videoFile && e.srtFile)[vi];
    const gidx = ep ? eps.indexOf(ep) : vi;
    if (r.success) {
      ok++;
      const dl = document.getElementById(`ep-dl-${gidx}`);
      if (dl) dl.classList.add('show');
    } else {
      fail++;
    }
  });

  document.getElementById('sOk').textContent  = ok;
  document.getElementById('sFail').textContent = fail;
  document.getElementById('sTot').textContent  = results.length;
  document.getElementById('summaryCard').classList.add('show');

  showMsg(
    fail === 0
      ? `‚úÖ All ${ok} episode${ok>1?'s':''} merged! Click ‚¨áÔ∏è Download on each episode.`
      : `‚ö†Ô∏è ${ok} succeeded, ${fail} failed.`,
    fail === 0 ? 'success' : 'error'
  );
  resetBtn();
}

// ‚îÄ‚îÄ ui helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showProg(i, v) {
  const el = document.getElementById(`ep-prog-${i}`);
  if (el) el.style.display = v ? 'block' : 'none';
}

function updateProgBar(i, pct, msg) {
  const fill  = document.getElementById(`ep-fill-${i}`);
  const msgEl = document.getElementById(`ep-msg-${i}`);
  const pctEl = document.getElementById(`ep-pct-${i}`);
  if (fill)  fill.style.width      = pct + '%';
  if (msgEl) msgEl.textContent     = msg;
  if (pctEl) pctEl.textContent     = pct + '%';
  showProg(i, true);
}

function setEpStatus(i, msg, cls) {
  const el  = document.getElementById(`ep-st-${i}`);
  const txt = document.getElementById(`ep-st-txt-${i}`);
  if (!el) return;
  el.className = `ep-status show ${cls}`;
  if (txt) txt.textContent = msg;
  const sp = el.querySelector('.spin');
  if (sp) sp.style.display = cls==='processing' ? 'block' : 'none';
}

function setCardClass(i, status) {
  const c = document.getElementById(`ep-card-${i}`);
  if (!c) return;
  c.classList.remove('processing','completed','error');
  if      (status==='processing') c.classList.add('processing');
  else if (status==='completed')  c.classList.add('completed');
  else if (status==='error')      c.classList.add('error');
}

function dlEp(i) {
  const validEps = eps.filter(e => e.videoFile && e.srtFile);
  const vi = validEps.indexOf(eps[i]);
  if (batchId && vi >= 0)
    window.open(`/download/${batchId}/${vi}`, '_blank');
}

function showMsg(html, type) {
  const el = document.getElementById('batchMsg');
  el.className = `batch-msg show ${type}`;
  el.innerHTML = html;
}

function resetBtn() {
  const btn = document.getElementById('mergeBtn');
  btn.classList.remove('loading');
  btn.disabled = false;
  updateBtn();
}

function fmtSize(b) {
  if (b>1073741824) return (b/1073741824).toFixed(2)+' GB';
  if (b>1048576)    return (b/1048576).toFixed(1)+' MB';
  return (b/1024).toFixed(1)+' KB';
}

function esc(s) {
  return String(s||'')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

document.addEventListener('keydown', e => {
  if ((e.ctrlKey||e.metaKey) && e.key==='Enter') {
    const btn = document.getElementById('mergeBtn');
    if (!btn.disabled) startMerge();
  }
});

addEp();
</script>
</body>
</html>
